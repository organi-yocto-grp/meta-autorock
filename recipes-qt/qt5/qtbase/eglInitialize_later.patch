From 0413d50461a5e93e78edd5be13327fac8078f95b Mon Sep 17 00:00:00 2001
From: chenzilin <chenzilin115@gmail.com>
Date: Sun, 30 Aug 2015 16:04:38 +0800
Subject: [PATCH] eglInitialize before create windows to reduce screen black
 time.

---
 .../eglconvenience/qeglplatformintegration.cpp           | 16 +++++++++++++---
 .../eglconvenience/qeglplatformintegration_p.h           |  1 +
 2 files changed, 14 insertions(+), 3 deletions(-)

diff --git a/src/platformsupport/eglconvenience/qeglplatformintegration.cpp b/src/platformsupport/eglconvenience/qeglplatformintegration.cpp
index 1868ff1..67a25f5 100644
--- a/src/platformsupport/eglconvenience/qeglplatformintegration.cpp
+++ b/src/platformsupport/eglconvenience/qeglplatformintegration.cpp
@@ -106,13 +106,22 @@ void QEGLPlatformIntegration::initialize()
     if (m_display == EGL_NO_DISPLAY)
         qFatal("Could not open egl display");
 
+    m_inputContext = QPlatformInputContextFactory::create();
+
+    m_vtHandler.reset(new QFbVtHandler);
+}
+
+void QEGLPlatformIntegration::create_initialize() const
+{
+    static int once=0;
+    if(once)
+        return;
+
     EGLint major, minor;
     if (!eglInitialize(m_display, &major, &minor))
         qFatal("Could not initialize egl display");
 
-    m_inputContext = QPlatformInputContextFactory::create();
-
-    m_vtHandler.reset(new QFbVtHandler);
+    once++;
 }
 
 void QEGLPlatformIntegration::destroy()
@@ -151,6 +160,7 @@ QPlatformBackingStore *QEGLPlatformIntegration::createPlatformBackingStore(QWind
 QPlatformWindow *QEGLPlatformIntegration::createPlatformWindow(QWindow *window) const
 {
     QWindowSystemInterface::flushWindowSystemEvents();
+    create_initialize();
     QEGLPlatformWindow *w = createWindow(window);
     w->create();
     if (window->type() != Qt::ToolTip)
diff --git a/src/platformsupport/eglconvenience/qeglplatformintegration_p.h b/src/platformsupport/eglconvenience/qeglplatformintegration_p.h
index 42fbf8c..b650538 100644
--- a/src/platformsupport/eglconvenience/qeglplatformintegration_p.h
+++ b/src/platformsupport/eglconvenience/qeglplatformintegration_p.h
@@ -64,6 +64,7 @@ public:
     ~QEGLPlatformIntegration();
 
     void initialize() Q_DECL_OVERRIDE;
+    void create_initialize() const;
     void destroy() Q_DECL_OVERRIDE;
 
     EGLDisplay display() const { return m_display; }
-- 
1.9.1

